@model EductaionDashboard.Models.StudentViewModel
@{
    ViewData["Title"] = "Student Dashboard";
}

<div class="dashboard-container">
    <!-- Header with welcome message -->
    <div class="dashboard-header">
        <h1><i class="k-icon k-i-user"></i> Student Dashboard</h1>
        <p class="welcome-text">Welcome back, Student! Here's your academic overview.</p>
    </div>

    <!-- Top cards for quick stats -->
    <div class="stats-container">
        <div class="stat-card">
            <div class="stat-icon"><i class="k-icon k-i-calendar"></i></div>
            <div class="stat-content">
                <div class="stat-value">92%</div>
                <div class="stat-label">Attendance</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon"><i class="k-icon k-i-chart-bar-column"></i></div>
            <div class="stat-content">
                <div class="stat-value">B+</div>
                <div class="stat-label">Avg. Grade</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon"><i class="k-icon k-i-clock"></i></div>
            <div class="stat-content">
                <div class="stat-value">5</div>
                <div class="stat-label">Upcoming Exams</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon"><i class="k-icon k-i-dollar"></i></div>
            <div class="stat-content">
                <div class="stat-value">Current</div>
                <div class="stat-label">Payment Status</div>
            </div>
        </div>
    </div>

    <!-- Filters section with improved styling -->
    <div class="filters-section k-card">
        <div class="k-card-header">
            <h3><i class="k-icon k-i-filter"></i> View Options</h3>
        </div>
        <div class="k-card-body filters-container">
            <div class="filter-group">
                <label for="classDropdown"><i class="k-icon k-i-folder-open"></i> Class:</label>
                <input id="classDropdown" style="width: 100%;" />
            </div>

            <div class="filter-group">
                <label for="subjectsDropdown"><i class="k-icon k-i-book"></i> Subjects:</label>
                <input id="subjectsDropdown" style="width: 100%;" />
            </div>
            
            <div class="filter-group">
                <label for="timeframeDropdown"><i class="k-icon k-i-calendar"></i> Timeframe:</label>
                <input id="timeframeDropdown" style="width: 100%;" />
            </div>
        </div>
    </div>

    <!-- Performance summary section -->
    <div class="performance-section k-card">
        <div class="k-card-header">
            <h3><i class="k-icon k-i-chart"></i> Performance Summary</h3>
        </div>
        <div class="k-card-body">
            <div id="performanceSplitter">
                <div id="performanceChart"></div>
                <div id="performancePieChart"></div>
            </div>
        </div>
    </div>

    <!-- Two column layout for exams and payments -->
    <div class="two-column-layout">
        <!-- Upcoming Exams section -->
        <div class="k-card exams-section">
            <div class="k-card-header">
                <h3><i class="k-icon k-i-calendar-date"></i> Upcoming Exams</h3>
            </div>
            <div class="k-card-body">
                <div id="examListView" class="exam-list"></div>
            </div>
        </div>

        <!-- Payments section -->
        <div class="k-card payments-section">
            <div class="k-card-header">
                <h3><i class="k-icon k-i-dollar"></i> Payments & Fee Management</h3>
            </div>
            <div class="k-card-body">
                <div class="payment-status">
                    <div class="payment-progress">
                        <span>Total Fees Paid: </span>
                        <div id="paymentProgress"></div>
                    </div>
                    <p>Next payment due: <strong>March 15, 2025</strong></p>
                </div>
                <button id="openActionSheet" class="k-button k-primary payment-button">
                    <i class="k-icon k-i-dollar"></i> Manage Payments
                </button>
                <div id="paymentActionSheet"></div>
            </div>
        </div>
    </div>
</div>

<script type="text/x-kendo-tmpl" id="examTemplate">
    <div class="exam-card">
        <div class="exam-subject">#= subject #</div>
        <div class="exam-details">
            <div class="exam-info">
                <i class="k-icon k-i-calendar"></i> 
                <span>#= kendo.toString(kendo.parseDate(date), "MMM dd, yyyy") #</span>
            </div>
            <div class="exam-info">
                <i class="k-icon k-i-clock"></i> 
                <span>#= time #</span>
            </div>
            <div class="exam-info">
                <i class="k-icon k-i-marker-pin"></i> 
                <span>#= venue #</span>
            </div>
        </div>
        <div class="exam-countdown" data-exam-date="#= date #"></div>
    </div>
</script>

<style>
    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background-color: #f5f7fa;
        color: #333;
    }

    .dashboard-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
    }

    /* Header styling */
    .dashboard-header {
        margin-bottom: 30px;
        background: linear-gradient(135deg, #4b6cb7, #182848);
        color: white;
        padding: 20px 30px;
        border-radius: 10px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .dashboard-header h1 {
        margin: 0;
        font-size: 2.2rem;
        display: flex;
        align-items: center;
    }

    .dashboard-header h1 .k-icon {
        margin-right: 10px;
    }

    .welcome-text {
        margin: 10px 0 0 0;
        font-size: 1.1rem;
        opacity: 0.9;
    }

    /* Stats cards styling */
    .stats-container {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 20px;
        margin-bottom: 30px;
    }

    .stat-card {
        background: white;
        border-radius: 10px;
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
        padding: 20px;
        display: flex;
        align-items: center;
        transition: transform 0.2s, box-shadow 0.2s;
    }

    .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }

    .stat-icon {
        background: linear-gradient(135deg, #4b6cb7, #182848);
        color: white;
        width: 50px;
        height: 50px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 15px;
    }

    .stat-icon .k-icon {
        font-size: 1.5rem;
    }

    .stat-content {
        flex: 1;
    }

    .stat-value {
        font-size: 1.8rem;
        font-weight: bold;
        color: #333;
        line-height: 1.2;
    }

    .stat-label {
        color: #666;
        font-size: 0.9rem;
    }

    /* Filters section styling */
    .filters-section {
        margin-bottom: 30px;
    }

    .filters-container {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 20px;
        padding: 15px;
    }

    .filter-group {
        display: flex;
        flex-direction: column;
    }

    .filter-group label {
        margin-bottom: 8px;
        font-weight: 500;
        display: flex;
        align-items: center;
    }

    .filter-group label .k-icon {
        margin-right: 5px;
    }

    /* Performance section styling */
    .performance-section {
        margin-bottom: 30px;
    }

    #performanceSplitter {
        height: 350px;
    }

    /* Two column layout */
    .two-column-layout {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 30px;
    }

    /* Exam cards styling */
    .exam-list {
        display: grid;
        gap: 15px;
        max-height: 500px;
        overflow-y: auto;
        padding: 5px;
    }

    .exam-card {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
        overflow: hidden;
        transition: transform 0.2s, box-shadow 0.2s;
        border-left: 4px solid #4b6cb7;
    }

    .exam-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .exam-subject {
        padding: 12px 15px;
        font-weight: bold;
        font-size: 1.1rem;
        background: rgba(75, 108, 183, 0.1);
        color: #4b6cb7;
    }

    .exam-details {
        padding: 15px;
    }

    .exam-info {
        display: flex;
        align-items: center;
        margin-bottom: 8px;
    }

    .exam-info .k-icon {
        margin-right: 8px;
        color: #4b6cb7;
    }

    .exam-countdown {
        padding: 8px 15px;
        background: #f5f7fa;
        text-align: right;
        font-size: 0.9rem;
        color: #666;
    }

    /* Payments section styling */
    .payment-status {
        margin-bottom: 20px;
    }

    .payment-progress {
        margin: 15px 0;
    }

    .payment-button {
        width: 100%;
        padding: 12px;
        font-size: 1rem;
    }

    /* Card header styling for all sections */
    .k-card-header {
        background: linear-gradient(to right, #f5f7fa, #f0f3f8);
        border-bottom: 1px solid #e0e5ee;
    }

    .k-card-header h3 {
        margin: 0;
        display: flex;
        align-items: center;
        font-size: 1.3rem;
        color: #4b6cb7;
    }

    .k-card-header h3 .k-icon {
        margin-right: 8px;
    }

    /* Responsive adjustments */
   
</style>

<script>
    $(document).ready(function () {
        // Kendo ComboBox for Class Selection
        $("#classDropdown").kendoComboBox({
            dataSource: ["Class 1", "Class 2", "Class 3", "Class 4", "Class 5"],
            placeholder: "Select Class",
            filter: "contains",
            animation: {
                open: {
                    effects: "fadeIn",
                    duration: 300
                }
            }
        });

        // Kendo MultiSelect for Subject Selection
        $("#subjectsDropdown").kendoMultiSelect({
            dataSource: ["Math", "Science", "English", "History", "Physics", "Computer Science", "Art"],
            placeholder: "Select Subjects",
            autoClose: false,
            tagMode: "single",
            animation: {
                open: {
                    effects: "fadeIn",
                    duration: 300
                }
            }
        });
        
        // Kendo DropDownList for Timeframe
        $("#timeframeDropdown").kendoDropDownList({
            dataSource: ["Current Term", "Last Term", "Entire Year", "Custom Range"],
            value: "Current Term",
            animation: {
                open: {
                    effects: "fadeIn",
                    duration: 300
                }
            }
        });

        // Kendo Splitter for Performance Summary
        $("#performanceSplitter").kendoSplitter({
            orientation: "horizontal",
            panes: [
                { size: "50%", collapsible: true },
                { size: "50%", collapsible: true }
            ]
        });

        // Try to access the performance data safely
        var performanceData;
        try {
            // First try to get it from the model
            performanceData = @Html.Raw(Json.Serialize(Model.PerformanceSummaryJson ?? "[]"));
            // If it's a string, parse it
            if (typeof performanceData === 'string') {
                performanceData = JSON.parse(performanceData || "[]");
            }
        } catch (e) {
            console.error("Error parsing performance data:", e);
            // Fallback data
            performanceData = [
                { category: "Math", value: 85 },
                { category: "Science", value: 78 },
                { category: "English", value: 92 },
                { category: "History", value: 88 },
                { category: "Physics", value: 76 }
            ];
        }

        // Use safely accessed data
        $("#performanceChart").kendoChart({
            title: { 
                text: "Subject Performance",
                font: "16px 'Segoe UI', sans-serif",
                color: "#333"
            },
            legend: {
                position: "bottom"
            },
            seriesDefaults: {
                type: "column",
                stack: false
            },
            series: [{
                name: "Current Grade",
                data: performanceData.map(p => p.value),
                color: "#4b6cb7",
                labels: {
                    visible: true,
                    template: "#= value #%",
                    background: "transparent"
                }
            }],
            valueAxis: {
                max: 100,
                title: {
                    text: "Performance (%)"
                },
                line: {
                    visible: false
                }
            },
            categoryAxis: {
                categories: performanceData.map(p => p.category),
                majorGridLines: {
                    visible: false
                }
            },
            tooltip: {
                visible: true,
                template: "#= category #: #= value #%"
            },
            chartArea: {
                background: "white"
            },
            theme: "flat"
        });

        // Kendo Pie Chart for Performance Breakdown with better styling
        $("#performancePieChart").kendoChart({
            title: {
                text: "Assignment Completion",
                font: "16px 'Segoe UI', sans-serif",
                color: "#333"
            },
            legend: {
                position: "bottom"
            },
            seriesDefaults: {
                type: "pie",
                labels: {
                    visible: true,
                    background: "transparent",
                    template: "#= category #: \n #= value #%"
                }
            },
            series: [{
                data: [
                    { category: "Completed", value: 85, color: "#4b6cb7" },
                    { category: "Pending", value: 10, color: "#f5b041" },
                    { category: "Late", value: 5, color: "#e74c3c" }
                ]
            }],
            tooltip: {
                visible: true,
                template: "#= category #: #= value #%"
            },
            chartArea: {
                background: "white"
            },
            theme: "flat"
        });

        // Kendo ListView for Upcoming Exams with improved data
        var examData = [
            { subject: "Mathematics", date: "2025-03-10", time: "10:00 AM", venue: "Room 101" },
            { subject: "Science", date: "2025-03-12", time: "12:00 PM", venue: "Lab 3" },
            { subject: "English", date: "2025-03-15", time: "9:00 AM", venue: "Room 202" },
            { subject: "History", date: "2025-03-18", time: "11:30 AM", venue: "Room 305" },
            { subject: "Physics", date: "2025-03-20", time: "2:00 PM", venue: "Room 108" }
        ];

        $("#examListView").kendoListView({
            dataSource: new kendo.data.DataSource({
                data: examData
            }),
            template: kendo.template($("#examTemplate").html())
        });
        
        // Calculate and display countdown for each exam
        function updateExamCountdowns() {
            $(".exam-countdown").each(function() {
                var examDate = new Date($(this).data("exam-date"));
                var now = new Date();
                var diffTime = examDate - now;
                var diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
                
                if (diffDays > 0) {
                    $(this).text(diffDays + " days remaining");
                } else {
                    $(this).text("Today!").css("color", "#e74c3c").css("font-weight", "bold");
                }
            });
        }
        
        updateExamCountdowns();
        setInterval(updateExamCountdowns, 3600000); // Update every hour
        
        // Kendo ProgressBar for payment status
        $("#paymentProgress").kendoProgressBar({
            min: 0,
            max: 100,
            value: 65,
            type: "value",
            animation: {
                duration: 600
            }
        });

        // Kendo ActionSheet for Payments with improved styling
        $("#openActionSheet").click(function () {
            $("#paymentActionSheet").data("kendoActionSheet").open();
        });

        $("#paymentActionSheet").kendoActionSheet({
            items: [
                { text: "Pay Fees Online", icon: "dollar", cssClass: "action-pay", click: function () { alert("Redirecting to payment gateway..."); } },
                { text: "Download Fee Receipt", icon: "download", cssClass: "action-download", click: function () { alert("Generating receipt..."); } },
                { text: "View Payment History", icon: "history", cssClass: "action-history", click: function () { alert("Loading payment history..."); } },
                { text: "Fee Structure", icon: "file-txt", cssClass: "action-structure", click: function () { alert("Loading fee structure..."); } },
                { text: "Cancel", icon: "close", cssClass: "action-close", click: function () { } }
            ]
        });
        
        // Add animation effects for a more dynamic dashboard
        $('.stat-card, .k-card').css('opacity', '0').css('transform', 'translateY(20px)');
        
        function animateElements() {
            $('.stat-card').each(function(index) {
                var $this = $(this);
                setTimeout(function() {
                    $this.animate({
                        opacity: 1,
                        transform: 'translateY(0)'
                    }, 300);
                }, index * 100);
            });
            
            $('.k-card').each(function(index) {
                var $this = $(this);
                setTimeout(function() {
                    $this.animate({
                        opacity: 1,
                        transform: 'translateY(0)'
                    }, 300);
                }, 400 + index * 150);
            });
        }
        
        setTimeout(animateElements, 100);
    });

    // Ajax call with loading indicator
    $.ajax({
        url: "/StudentDashboard/GetData",
        type: "GET",
        beforeSend: function() {
            $("<div class='loading-indicator'><div class='spinner'></div><div>Loading data...</div></div>").appendTo("body");
        },
        success: function (data) {
            console.log("Data received:", data);
            // Update dashboard with received data
        },
        error: function (xhr, status, error) {
            console.error("AJAX error:", status, error);
            // Show error notification
            $("<div class='error-notification'>Failed to load data. Please try again.</div>").appendTo("body").fadeIn().delay(3000).fadeOut();
        },
        complete: function() {
            $(".loading-indicator").remove();
        }
    });
</script>