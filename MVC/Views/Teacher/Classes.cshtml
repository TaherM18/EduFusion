@{
    ViewData["Title"] = "Classes";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@section Scripts {
    <script>
        const teacher = GetUserData();
        const teacherID = teacher ? teacher.userID : 57;
        let apiBaseUrl = "http://localhost:5190/api";

        var standardApi = `${apiBaseUrl}/api/standard`;
        var subjectApi = `${apiBaseUrl}/api/standard`;
        var teacherApi = `${apiBaseUrl}/api/Teacher/GetTeacherBySubject`;

        @* // Initialize Kendo Window
        var formWindow = $("#container").kendoWindow({
            title: "Add Class",
            width: "400px",
            height: "450px",
            visible: false,
            modal: true,
            actions: ["Close"]
        }).data("kendoWindow");

        $("#add-class").click(function () {
            formWindow.center().open();
        }); *@

            $("#form-container").kendoForm({
                orientation: "vertical",
                formData: {
                    classID: null,
                    subjectID: null,
                    teacher: "",
                    timeSlot: null
                },
                items: [
                    {
                        field: "standardID",
                        label: "Standard",
                        editor: "DropDownList",
                        editorOptions: {
                            optionLabel: "Select Standard",
                            dataTextField: "standardName",
                            dataValueField: "standardID",
                            dataSource: {
                                transport: { read: standardApi }
                            },
                            change: function (e) {
                                var selectedStandard = this.value();
                                fetchSubject(selectedStandard);
                            }
                        }
                    },
                    {
                        field: "subjectID",
                        label: "Subject",
                        editor: "DropDownList",
                        editorOptions: {
                            optionLabel: "Select Subject",
                            dataTextField: "subjectName",
                            dataValueField: "subjectID",
                            dataSource: [],
                            change: function (e) {
                                var selectedSubject = this.value();
                                fetchTeacher(selectedSubject);
                            }
                        }
                    },
                    {
                        field: "teacher",
                        label: "Teacher",
                        editor: "TextBox",
                        editorOptions: { readonly: true }
                    },
                    {
                        field: "startTime",
                        label: "Start Time",
                        editor: "TimePicker"
                    },
                    {
                        field: "endTime",
                        label: "End Time",
                        editor: "TimePicker"
                    }
                ]
            });

        function fetchSubject(selectedStandard) {
            $.ajax({
                url: subjectApi + "/" + selectedStandard,
                type: "GET",
                success: function (data) {
                    console.log(`fetchSubject(${selectedStandard})\n`, data.subjects);
                    var subjectDropdown = $("#form-container").find("[name=subjectID]").data("kendoDropDownList");
                    subjectDropdown.setDataSource(new kendo.data.DataSource({ data: data.subjects }));
                    subjectDropdown.value(""); // Reset value
                }
            });
        }

        function fetchTeacher(selectedSubject) {
            $.ajax({
                url: teacherApi + "/" + selectedSubject,
                type: "GET",
                success: function (data) {
                    var teacherTextBox = $("#form-container").find("[name=teacher]").data("kendoTextBox");
                    teacherTextBox.value(data.user.firstName);
                }
            })
        }

        $("#scheduler").kendoScheduler({
            date: new Date(),
            startTime: new Date("2024-03-03T08:00:00"),
            endTime: new Date("2024-03-03T17:00:00"),
            views: [
                "day",
                "week",
                "month",
                "agenda"
            ],
            dataSource: {
                transport: {
                    read: {
                        url: `${baseUrl}/timetable/teacher/${teacherID}`,
                        dataType: "json"
                    }
                },
                schema: {
                    parse: function (response) {
                        return response.map(item => ({
                            timetableID: item.timetableID,
                            subjectID: item.subjectID,
                            classID: item.classID,
                            dayOfWeek: item.dayOfWeek,
                            dayName: item.dayName,
                            start: new Date(`2024-03-04T${item.startTime}`), // Convert time to Date
                            end: new Date(`2024-03-04T${item.endTime}`),
                            subjectName: item.subject.subjectName,
                            className: item.classModel.className
                        }));
                    },
                    model: {
                        id: "timetableID",
                        fields: {
                            timetableID: { type: "number" },
                            subjectID: { type: "number" },
                            classID: { type: "number" },
                            dayOfWeek: { type: "number" },
                            dayName: { type: "string" },
                            start: { type: "date" },
                            end: { type: "date" },
                            subjectName: { type: "string" },
                            className: { type: "string" }
                        }
                    }
                }
            },
            editable: true,
            eventTemplate: "#= className # - #= subjectName # - #= kendo.toString(start, 'HH:mm') # to #= kendo.toString(end, 'HH:mm') #"
        });
    </script>
}

<h1>Classes</h1>

@* <button id="add-class" class="k-button k-button-solid-primary">Add Class</button> *@

@* <div id="container">
    <div id="form-container"></div>
</div> *@

<div id="scheduler"></div>
